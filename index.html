<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>جامعة الملك عبدالعزيز - المساعد الذكي</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">
<style>
/* لا تعديل على التنسيق */
</style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="university-info">
                <div>
                    <h1>جامعة الملك عبدالعزيز</h1>
                    <div class="tagline">المساعد الذكي المتقدم</div>
                </div>
            </div>
            <div class="logo-container" onclick="document.getElementById('logoInput').click()">
                <div class="logo">
                    <!-- ✅ شعار وهمي افتراضي -->
                    <img id="logoImage" class="logo-image" src="png-clipart-king-abdulaziz-university-dar-al-hekma-university-king-saud-university-education-saudi-gazette-label-logo.png" alt="شعار الجامعة" style="display:block;">
                    <div class="logo-placeholder" id="logoPlaceholder" style="display:none;">
                        <i class="fas fa-university"></i>
                        <span>إضافة الشعار</span>
                    </div>
                </div>
                <input type="file" id="logoInput" class="logo-input" accept="image/*">
            </div>
        </div>
    </header>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-card">
                    <div class="welcome-logo">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h2 class="welcome-title">السلام عليكم وأهلاً وسهلاً بك! 🎓</h2>
                    <p class="welcome-subtitle">
                        أنا مساعدك الذكي في جامعة الملك عبد العزيز. أستخدم أحدث تقنيات الذكاء الاصطناعي لأقدم لك أفضل المساعدة والإجابات الدقيقة على جميع استفساراتك.
                    </p>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="avatar"><i class="fas fa-robot"></i></div>
                <div class="typing-bubble">
                    <span class="typing-text">جاري البحث...</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="quick-actions">
                <button class="quick-action" data-message="ما هي معلومات التسجيل في جامعة الملك عبدالعزيز؟">📝 معلومات التسجيل</button>
                <button class="quick-action" data-message="متى مواعيد الاختبارات في جامعة الملك عبدالعزيز؟">📅 مواعيد الاختبارات</button>
                <button class="quick-action" data-message="ما هي الخدمات الطلابية المتاحة في جامعة الملك عبدالعزيز؟">🎓 الخدمات الطلابية</button>
                <button class="quick-action" data-message="كيف أصل إلى المكتبة الرقمية في جامعة الملك عبدالعزيز؟">📚 المكتبة الرقمية</button>
            </div>
            <div class="input-container">
                <input type="text" class="message-input" id="messageInput" placeholder="اكتب رسالتك هنا...">
                <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<script>
/* ⚙️ نفس الإعدادات الأصلية مع تصحيح وظيفة الإرسال */
let messages = [];
let isFirstMessage = true;
let conversationHistory = [];

const API_CONFIG = {
    baseURL: 'https://api.perplexity.ai',
    endpoint: '/chat/completions',
    apiKey: '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',
    model: 'sonar-pro',
    maxTokens: 1000,
    temperature: 0.7
};

const SYSTEM_PROMPT = "أنت مساعد ذكي لجامعة الملك عبدالعزيز. أجب على أسئلة الطلاب بوضوح واحترافية.";

const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const welcomeScreen = document.getElementById('welcomeScreen');
const quickActions = document.querySelectorAll('.quick-action');
const logoInput = document.getElementById('logoInput');
const logoImage = document.getElementById('logoImage');
const logoPlaceholder = document.getElementById('logoPlaceholder');

/* ✅ إصلاح: جعل زر الإرسال يعمل فعلاً */
sendButton.addEventListener('click', () => sendMessage());
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});
quickActions.forEach(btn => btn.addEventListener('click', () => sendMessage(btn.dataset.message)));

logoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = ev => {
            logoImage.src = ev.target.result;
            logoImage.style.display = 'block';
            logoPlaceholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
});

async function sendMessage(preMsg = null) {
    const msg = preMsg || messageInput.value.trim();
    if (!msg) return;

    if (isFirstMessage) {
        welcomeScreen.style.display = 'none';
        isFirstMessage = false;
    }

    addMessage(msg, 'user');
    messageInput.value = '';
    sendButton.disabled = true;

    showTypingIndicator();
    try {
        const res = await getAIResponse(msg);
        hideTypingIndicator();
        addMessage(res, 'bot');
    } catch {
        hideTypingIndicator();
        addMessage("حدث خطأ أثناء معالجة طلبك.", 'bot');
    } finally {
        sendButton.disabled = false;
        messageInput.disabled = false;
    }
}

function addMessage(content, type) {
    const el = document.createElement('div');
    el.className = `message ${type}`;
    el.innerHTML = `
        <div class="message-content">
            <div class="avatar">${type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}</div>
            <div><div class="message-bubble">${content}</div></div>
        </div>`;
    chatMessages.insertBefore(el, typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function getAIResponse(userMessage) {
    conversationHistory.push({ role: 'user', content: userMessage });
    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoint}`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${API_CONFIG.apiKey}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: API_CONFIG.model,
            messages: [{ role: 'system', content: SYSTEM_PROMPT }, ...conversationHistory],
            max_tokens: API_CONFIG.maxTokens,
            temperature: API_CONFIG.temperature
        })
    });
    const data = await response.json();
    const aiText = data.choices?.[0]?.message?.content || "لم يتم العثور على إجابة.";
    conversationHistory.push({ role: 'assistant', content: aiText });
    return aiText;
}

function showTypingIndicator() { typingIndicator.style.display = 'flex'; chatMessages.scrollTop = chatMessages.scrollHeight; }
function hideTypingIndicator() { typingIndicator.style.display = 'none'; }
</script>
</body>
</html>
